pipeline {
    agent any
    environment {
        NETBOX_API   = "http://netbox-docker-netbox-1:8080/"
        NETBOX_TOKEN = credentials('netbox-api-token')
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/baltah666/netbox-automation-v02.git', credentialsId: 'github-cred'
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    ansible-galaxy collection install netbox.netbox
                '''
            }
        }

        stage('Get Devices List') {
            steps {
                script {
                    def raw = sh(script: ". venv/bin/activate && python3 get_devices.py --quiet", returnStdout: true).trim()
                    writeFile file: 'devices.json', text: raw
                }
            }
        }

        stage('1. device.json') {
            steps {
                script {
                    def devices = readJSON file: 'devices.json'
                    parallel devices.collectEntries { dev ->
                        ["${dev}": {
                            sh """. venv/bin/activate && ansible-playbook -i netbox_inv.yml generate_config.yml --limit ${dev} --tags device || true"""
                        }]
                    }
                }
            }
        }

        stage('2. interfaces.json') {
            steps {
                script {
                    def devices = readJSON file: 'devices.json'
                    parallel devices.collectEntries { dev ->
                        ["${dev}": {
                            sh """. venv/bin/activate && ansible-playbook -i netbox_inv.yml generate_config.yml --limit ${dev} --tags interfaces || true"""
                        }]
                    }
                }
            }
        }

        stage('3. ip_addresses.json') {
            steps {
                script {
                    def devices = readJSON file: 'devices.json'
                    parallel devices.collectEntries { dev ->
                        ["${dev}": {
                            sh """. venv/bin/activate && ansible-playbook -i netbox_inv.yml generate_config.yml --limit ${dev} --tags ip_addresses || true"""
                        }]
                    }
                }
            }
        }

        stage('4. site.json') {
            steps {
                script {
                    def devices = readJSON file: 'devices.json'
                    parallel devices.collectEntries { dev ->
                        ["${dev}": {
                            sh """. venv/bin/activate && ansible-playbook -i netbox_inv.yml generate_config.yml --limit ${dev} --tags site || true"""
                        }]
                    }
                }
            }
        }

        stage('5. vlans.json') {
            steps {
                script {
                    def devices = readJSON file: 'devices.json'
                    parallel devices.collectEntries { dev ->
                        ["${dev}": {
                            sh """. venv/bin/activate && ansible-playbook -i netbox_inv.yml generate_config.yml --limit ${dev} --tags vlans || true"""
                        }]
                    }
                }
            }
        }

        stage('6. generate_config') {
            steps {
                script {
                    def devices = readJSON file: 'devices.json'
                    parallel devices.collectEntries { dev ->
                        ["${dev}": {
                            sh """. venv/bin/activate && ansible-playbook -i netbox_inv.yml generate_config.yml --limit ${dev} --tags generate_config || true"""
                        }]
                    }
                }
            }
        }

        stage('Git Push Changes') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'github-cred-token', usernameVariable: 'USER', passwordVariable: 'TOKEN')]) {
                    sh '''
                        git config --global user.email "jenkins@local"
                        git config --global user.name "Jenkins"
                        git add configs/ || true
                        git commit -m "Auto-generated configs from Jenkins pipeline" || true
                        git push https://${USER}:${TOKEN}@github.com/baltah666/netbox-automation-v02.git main || true
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished."
        }
    }
}
